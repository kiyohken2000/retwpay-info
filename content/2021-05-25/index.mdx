---
title: PINE proã«ãƒãƒ£ãƒƒãƒˆBotã‚’å®Ÿè£…ã—ã¾ã—ãŸ
tags: [    ]
date: 2021-05-25
path: blog/2021-05-25
cover: ./img.jpg
excerpt: Build a Messenger with React Native and Firebase. Part 13
keywords:
  - é–‹ç™º
  - Firebase
  - React Native
  - ã‚³ãƒ¼ãƒ‰
  - code
  - PINE
---
import { Link } from 'gatsby';

## Streamã‚¿ãƒ–ã«ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆãŒã„ã‚‹éƒ¨å±‹ã‚’ä½œã‚Šã¾ã—ãŸ

æ—¥ä»˜ã®æ¨ªã«**ãƒ­ãƒœãƒƒãƒˆçµµæ–‡å­—**ãŒã¤ã„ã¦ã‚‹éƒ¨å±‹ã«ãƒœãƒƒãƒˆãŒã„ã¾ã™ã€‚

![](./img1.png)

ãƒœãƒƒãƒˆéƒ¨å±‹å†…ã®å…¨ã¦ã®ç™ºè¨€ã«ãƒœãƒƒãƒˆãŒåå¿œã—ã¾ã™ã€‚

![](./img2.png)

## ä»•çµ„ã¿

ä½¿ç”¨æŠ€è¡“ã¯ä»¥ä¸‹ã®2ã¤ã§ã™ã€‚

- A3RT
- Firebase Cloud Functions

<br/>

### A3RT

ãƒªã‚¯ãƒ«ãƒ¼ãƒˆã®AIã€[A3RT](https://a3rt.recruit-tech.co.jp/product/talkAPI/)ã®Talk AIã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã—ãŸã€‚

ã“ã‚“ãªæ„Ÿã˜ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã¨

```
curl -X POST https://api.a3rt.recruit-tech.co.jp/talk/v1/smalltalk \
-F "apikey=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" \
-F "query=ãŠã¯ã‚ˆã†"
```

ã“ã‚“ãªæ„Ÿã˜ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã™ã€‚

```
{
	status: 0,
	message: "ok",
	results: [{
		perplexity: 2.3688167429546714,
		reply: "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™"
	}],
}
```

### Firebase Cloud Functions

ä¸Šè¨˜ã®A3RTã¨<Link to="/blog/2021-04-08">ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®å®Ÿè£…ã«ã‚‚ä½¿ã£ã¦ã„ã‚‹</Link>Cloud Functionsã‚’çµ„ã¿åˆã‚ã›ã¾ã—ãŸã€‚

ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã¯Firestoreã®

`THREADS(ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)`/`{ãƒãƒ£ãƒƒãƒˆéƒ¨å±‹ã®ID}(ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)`/`MESSAGES(ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)`/`{ç™ºè¨€ã”ã¨ã®ID}(ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)`

ã®ä¸­ã«æ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

![](./img3.png)

Cloud Functionsã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›¸ãè¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã§ãã‚‹(onCreate)ã®ã§`{ç™ºè¨€ã”ã¨ã®ID}`ãŒä½œæˆã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’Firestoreã«æ ¼ç´ã™ã‚‹ã“ã¨ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚

## å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰

### Cloud Functionsã®å®Ÿè£…

Cloud Functionsã®ã‚³ãƒ¼ãƒ‰ãŒãƒ¡ã‚¤ãƒ³ã«ãªã‚Šã¾ã™ã€‚BOTãŒã„ã‚‹éƒ¨å±‹ã¯å›ºå®šã®ãŸã‚`THREADS`ç›´ä¸‹ã®ãƒãƒ£ãƒƒãƒˆéƒ¨å±‹IDã¯å›ºå®šã§ã™ã€‚

**functions\index.js**

```javascript
exports.botMessage = functions.region('asia-northeast2').firestore
  .document('THREADS/WIMi5WBba4N2XNtK5o5g/MESSAGES/{chatId}') // BOTéƒ¨å±‹ã®ãƒ‘ã‚¹
  .onCreate((snap, context) => { // ç™ºè¨€ãŒã‚ã£ãŸã“ã¨(ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹)ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã™ã‚‹
    const newValue = snap.data(); 
    const comment = newValue.text; // æ–°ç€ç™ºè¨€ã®å†…å®¹ã‚’æ ¼ç´
    const u = newValue.user._id // æ–°ç€ç™ºè¨€è€…ã®IDã‚’æ ¼ç´

    if (u != 'XVY0p3KFxVaaQtq25JwlwWafUbs1') { // ç™ºè¨€è€…IDã¨BOTã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®IDã‚’æ¯”è¼ƒã—ã¦ã€ä¸€è‡´ã—ãªã‘ã‚Œã°(BOTã®ç™ºè¨€ã˜ã‚ƒãªã‘ã‚Œã°)ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å‡¦ç†ã¸
      const params = new URLSearchParams();
      params.append('apikey', "API key è¦‹ã›ã‚‰ã‚Œãªã„ã‚ˆ");ã€€// apikeyãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆ
      params.append('query', comment);ã€€// queryãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆ
      fetch('https://api.a3rt.recruit-tech.co.jp/talk/v1/smalltalk',{ // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«API keyã¨ç™ºè¨€ã‚’é€ä¿¡
        method: 'post',
        body: params
      }).then(response => {
        response.json().then(data => {
          console.log(data.results[0].reply);
          const text = data.results[0].reply; // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡ã‚’æ ¼ç´
          const messageRef = db.collection('THREADS'); // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’BOTã®ç™ºè¨€ã¨ã—ã¦Firestoreã«ä¿å­˜ã™ã‚‹å‡¦ç†
          messageRef
          .doc('WIMi5WBba4N2XNtK5o5g') // BOTéƒ¨å±‹ã®ID
          .collection('MESSAGES')
          .add({
            text, // è¿”ã£ã¦ããŸãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡
            createdAt: new Date().getTime(),
            user: { // BOTã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±
              _id: 'XVY0p3KFxVaaQtq25JwlwWafUbs1',
              email: 'pineprobot@pinepro.ml',
              avatar: 'https://firebasestorage.googleapis.com/v0/b/kenmochat.appspot.com/o/avatar%2FXVY0p3KFxVaaQtq25JwlwWafUbs11621592754467?alt=media&token=f2366ddf-dc22-4977-a80c-496c5394c8fb',
              name: 'PINE pro BOT',
            }
          });
        })
      }).catch(error => console.log(error));
    } else { null }
});
```

### ã‚¢ãƒ—ãƒªå´ã®å®Ÿè£…

ã‚¢ãƒ—ãƒªå´ã¯ã»ã¼å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“ã€‚BOTéƒ¨å±‹ã«**ãƒ­ãƒœãƒƒãƒˆçµµæ–‡å­—**ã‚’è¡¨ç¤ºã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã—ãŸã ã‘ã§ã™ã€‚

**src\scenes\stream\Stream.js**

```javascript
{
  threads.map((talk, i) => {
    return (
      <View key={i} style={styles.item}>
        <TouchableOpacity onPress={() => props.navigation.navigate('Chat', { talkData: talk, myProfile: userData })}>
          <View style={{flexDirection: 'row'}}>
            <View style={styles.avatar}>
              <Avatar
                size="medium"
                rounded
                title="NI"
                source={{ uri: talk.latestMessage.avatar }}
              />
            </View>
            <View style={{ flex: 1, width: '100%' }}>
              <Text style={styles.title} numberOfLines={1}>{talk.name}</Text>
              <Text style={styles.latestMessage} numberOfLines={1}>{talk.latestMessage.text}</Text>
              <View style={styles.datecontainer}>
                {talk.id === 'WIMi5WBba4N2XNtK5o5g'?<Text>ğŸ¤–bot roomğŸ¤–</Text>:null} {/* ãƒãƒ£ãƒƒãƒˆéƒ¨å±‹ã®IDã‚’BOTéƒ¨å±‹ã®IDã‚’æ¯”è¼ƒã—ã¦ä¸€è‡´ã™ã‚Œã°å°ã‚’ã¤ã‘ã‚‹ */}
                <Text style={styles.latestDate}>{displaytime(talk.latestMessage.createdAt)}</Text>
              </View>
            </View>
          </View>
        </TouchableOpacity>
        <Divider />
      </View>
    )
  })
}
```

## ã¾ã¨ã‚

[Zapier](https://zapier.com/apps/chatbot/integrations)ã¨ã‹[Dialogflow](https://cloud.google.com/dialogflow/?hl=ja)ã¨ã‹[Microsoft Azure Bot Service](https://azure.microsoft.com/ja-jp/services/bot-services/)ã‚‚è©¦ã—ãŸã®ã§ã™ãŒã€BOTè‡ªä½“ã®æ€§èƒ½ã«ã“ã ã‚ã‚Šã¯ãªã‹ã£ãŸã®ã§æœ€ã‚‚ãŠæ‰‹è»½ã«ã§ããã†ãªA3RTã‚’ä½¿ã„ã¾ã—ãŸã€‚

å®Ÿéš›ã€ã‹ãªã‚Šç°¡å˜ã«å®Ÿè£…ã§ãã¦è‰¯ã‹ã£ãŸã§ã™ã€‚

---
---
title: PINE proã«ç¿»è¨³BOTã‚’è¿½åŠ ã—ã¾ã—ãŸ
tags: [    ]
date: 2021-06-02
path: blog/2021-06-02
cover: ./img.png
excerpt: Build a Messenger with React Native and Firebase. Part 21
keywords:
  - é–‹ç™º
  - Firebase
  - React Native
  - ã‚³ãƒ¼ãƒ‰
  - code
  - PINE
---
import { Link } from 'gatsby';

## ç¿»è¨³BOTã‚’è¿½åŠ ã—ã¾ã—ãŸ

**æ—¥æœ¬èªâ†’ãƒ­ã‚·ã‚¢èª**ã¨**æ—¥æœ¬èªâ†’éŸ“å›½èª**ã®ç¿»è¨³BOTãŒã„ã‚‹éƒ¨å±‹ã‚’ä½œã‚Šã¾ã—ãŸã€‚GCPã®Cloud Translation APIã‚’åˆ©ç”¨ã—ã¦å®Ÿè£…ã—ã¾ã—ãŸã€‚

![](./img1.jpg)

## å¤‰æ›´ã—ãŸã‚³ãƒ¼ãƒ‰

### æº–å‚™

GCPã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§Cloud Translation APIã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚

![](./img2.png)

APIã‚­ãƒ¼ã¯Cloud Visionã§ä½¿ã£ã¦ã„ã‚‹ã‚‚ã®ã‹ã‚‰æµç”¨ã—ã¾ã—ãŸã€‚

## ã‚³ãƒ¼ãƒ‰

### Cloud Functionsã®å¤‰æ›´

ãƒ­ã‚·ã‚¢èªç”¨ã¨éŸ“å›½èªç”¨ã®é–¢æ•°ã‚’ãã‚Œãã‚Œä½œã‚Šã¾ã—ãŸã€‚

**functions\index.js**

```javascript
exports.translation = functions.region('asia-northeast2').firestore
  .document('THREADS/o65qDbjlphSbs281TDX3/MESSAGES/{chatId}') // ç¿»è¨³éƒ¨å±‹ã¯å›ºå®šãªã®ã§ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®IDã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã™ã‚‹
  .onCreate((snap, context) => {
    const newValue = snap.data();
    const comment = newValue.text; // æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    const user = newValue.user._id; // ç™ºè¨€è€…ã®IDã‚’å–å¾—
    const messageRef = db.collection('THREADS').doc('o65qDbjlphSbs281TDX3').collection('MESSAGES'); // ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®ãƒ‘ã‚¹å®šç¾©
    const t = new Date().getTime(); // BOTã®ç™ºè¨€æ—¥æ™‚ã‚’å®šç¾©
    const u = { // BOTæƒ…å ±ã‚’å®šç¾©
      _id: 'vScvjdhKU8VgjrIwINThWEAYUro1',
      email: 'pineprotranslation@pinepro.ml',
      avatar: 'https://firebasestorage.googleapis.com/v0/b/kenmochat.appspot.com/o/avatar%2FvScvjdhKU8VgjrIwINThWEAYUro11622597058533?alt=media&token=ee015141-d7b5-4d1c-919a-8067b642f26a',
      name: 'PINE pro translation BOT ru',
    };

    const fromLang = 'ja' // ç¿»è¨³å…ƒã®è¨€èª
    const toLang = 'ru' // ç¿»è¨³èªã®è¨€èª
    const apiKey = 'API keyã¯è¦‹ã›ã‚‰ã‚Œãªã„ã‚ˆ'

    // APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’å®šç¾©
    const URL = "https://translation.googleapis.com/language/translate/v2?key="+apiKey+"&q="+encodeURI(comment)+"&source="+fromLang+"&target="+toLang
    const options = {
      url: URL,
      method: 'GET',
      json: true
    }

    if (user != 'vScvjdhKU8VgjrIwINThWEAYUro1') { // BOTãŒè‡ªåˆ†ã®ç™ºè¨€ã«åå¿œã—ãªã„ã‚ˆã†ã«ã™ã‚‹
      request(options, function (error, response, body) {
        console.log(body.data.translations[0].translatedText);
        const text = body.data.translations[0].translatedText; // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—
          messageRef
          .add({ // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’Firestoreã«BOTã®ç™ºè¨€ã¨ã—ã¦è¿½åŠ ã™ã‚‹
            text,
            createdAt: t,
            user: u
          });
        if (error) {
          const text = 'ã‚ã‹ã‚‰ã‚“';
            messageRef
            .add({
              text,
              createdAt: t,
              user: u
            });
        }
      })
    } else { null }
});
```

### ã‚¢ãƒ—ãƒªå´ã®å¤‰æ›´

ãƒˆãƒ¼ã‚¯ä¸€è¦§ç”»é¢ã§ã¯BOTéƒ¨å±‹ã«ç›®å°ã‚’ã¤ã‘ã¦ã„ã‚‹ã®ã§ã€ç¿»è¨³éƒ¨å±‹ã«ã‚‚ãã‚Œãã‚Œè¿½åŠ ã—ã¾ã™ã€‚

![](./img3.jpg)

**src\scenes\stream\Stream.js**

éƒ¨å±‹ã®IDã‚’è©•ä¾¡ã—ã¦ãã‚Œãã‚Œã®éƒ¨å±‹ã«å°ã‚’ã¤ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```javascript
<View style={styles.datecontainer}>
  {talk.id === 'Dj04ExLoykNI2sbmOVeW' ?
    (<Text style={scheme === 'dark' ? styles.darkbot : styles.bot}>ğŸ¤–bot roomğŸ¤–</Text>) :
    talk.id === 'o65qDbjlphSbs281TDX3' ?
    (<Text style={scheme === 'dark' ? styles.darkbot : styles.bot}>ğŸ‘â€ğŸ—¨RussianğŸ‘â€ğŸ—¨</Text>) :
    talk.id === 'T5XMlAahT3dWwHfxFnqH' ?
    (<Text style={scheme === 'dark' ? styles.darkbot : styles.bot}>ğŸ”„KoreanğŸ”„</Text>) :
    null
  }
  <Text style={scheme === 'dark' ? styles.darklatestDate : styles.latestDate}>{displaytime(talk.latestMessage.createdAt)}</Text>
</View>
```

## ã¾ã¨ã‚

ç¿»è¨³APIã¯ä»¥å‰ã‹ã‚‰ä½¿ã„ãŸã‹ã£ãŸã®ã§å®Ÿè£…ã§ãã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚

---